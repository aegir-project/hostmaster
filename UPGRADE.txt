-*-rst-*-

This document is formatted using the ReST syntax.

Aegir 0.2 upgrade instructions
==============================

This document describes briefly how to upgrade existing Aegir
platforms.

Upgrading the Drupal core safely
--------------------------------

If you want to use provision to upgrade your Aegir installation, you
can, but it's a bit more tricky than a usual site because you cannot
(yet) use the regular frontend to do that. The first step is to
import and verify the "default" site so it has a proper
configuration. Then it can be migrated to a new platform.

Shell commands::
 cd /var/aegir
 ./drush/drush.php dl drupal
 cd drupal-6.12
 cvs co -d profiles/hostmaster contributions/profiles/hostmaster
 cvs co -d profiles/hostmaster/modules/hosting contributions/modules/hosting
 cvs co -d profiles/hostmaster/themes/eldir contributions/themes/eldir
 # also checkout any modules you may have enabled in the d5 platform
 # now you want to add the platform in the frontend (Create content -> platform) and wait for the task to be processed
 cd ../drupal-5.x
 /var/hostmaster/drush/drush.php --verbose=2 provision verify
 /var/hostmaster/drush/drush.php --verbose=2 provision import default
 /var/hostmaster/drush/drush.php --verbose=2 provision verify default
 /var/hostmaster/drush/drush.php --verbose=2 provision backup default ~/default.tar.gz
 cd ../drupal-6.12
 /var/hostmaster/drush/drush.php --verbose=2 provision verify
 /var/hostmaster/drush/drush.php --verbose=2 provision deploy d6.aegir.example.com ~/default.tar.gz
 # review changes, see if it works to your liking, when you're done:
 /var/hostmaster/drush/drush.php --verbose=2 provision deploy default ~/default.tar.gz
 /var/hostmaster/drush/drush.php --verbose=2 provision delete d6.aegir.example.com
 crontab -e # change root to new platform, make sure you have a --uri
 vi /var/hostmaster/config/vhost.d/aegir.example.com # change the document root to the new platform

This will likely create a new vhost named "default" in
/var/hostmaster/config/vhost.d. This will likely conflict with your already
existing vhost there (which is probably more something like aegir.example.com).
The recommended way is to remove the 'default' file. Make sure you fix your
existing config file to point to the right path however.

See http://drupal.org/node/453540 for more details about this issue.

Upgrading Hostmaster from 0.1
-----------------------------

Upgrading hostmaster should be as simple as removing the provision and
drush modules from your profiles/hostmaster/modules directory. You
also need to create a new drush and provision checkout. Finally, you
can remove the drush.php symlink.

You will also need to update the hosting module and run update.php so
that new changes to the database are taken into account. This will
trigger platform verification and other cleanup tasks.

Finally, you will need to put the path to that new drush in the
webserver node configuration. Rerunning the wizard will prompt you for
that. Make sure you also run the hosting setup command.

Shell commands::
 export CVSROOT=:pserver:anonymous:anonymous@cvs.drupal.org:/cvs/drupal
 cd /var/aegir
 cvs co -d drush  contributions/modules/drush
 mkdir .drush
 cvs co -d .drush/provision  contributions/modules/provision
 rm drupal-5.x/drush.php
 rm -r drupal-5.x/profiles/hostmaster/modules/provision
 rm -r drupal-5.x/profiles/hostmaster/modules/drush
 cvs up -A drupal-5.x/profiles/hostmaster/modules/hosting
 # here run update.php on the site and setup your drush path
 cd drupal-5.x && ../drush/drush.php hosting setup

The above commands need to be ran as your "aegir" user, especially the
last step.

Upgrading Hostslave platforms from 0.1
--------------------------------------

Provision has been migrated out of the platforms. It used to be
installed in the profiles/hostslave/modules directory. It is now in
~/.drush/provision. So you can simply cleanup the hostslave profile
and the virtual host created for the hostslave profile. You can also
remove the drush symlink.

Shell commands::
 cd /var/aegir
 rm -r drupal-6.x/profiles/hostslave
 rm config/vhost.d/hostslave
 rm drupal-6.x/drush.php

You should also delete the database created during the hostslave
install:

SQL commands::
 DROP DATABASE hostslave;
